---
title: "Stats 460 Final Project"
author: "Kiri Daust"
date: "30/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(foreach)
library(tidyverse)
library(ggmcmc)
load("BayesProj.Rdata")
```

```{r}
X <- dat$X
y <- dat$Y

lmfit <- lm(y ~ 0 + X) ##run linear model to get coefficients
betaLSE <- lmfit$coefficients
p <- 10
n <- 300

epsilon <- 10^(-4)
tau2 <- 10^2
api <- 1; bpi <- 1

deltaParam <- function(pi,tau2,betaj,epsilon){
  p1 <- pi*exp(-(1/(2*tau2))*betaj^2)
  p0 <- (((1-pi)*sqrt(tau2))/sqrt(epsilon))*exp(-(1/(2*epsilon))*betaj^2)
  return(p1/(p1+p0))
}

betaParam <- function(deltaj,tau2,epsilon,ysquig,x){
  if(deltaj == 1){
    num <- sum(ysquig*x)
    denom <- sum(x^2) + 1/tau2
    return(c(num/denom,1/(denom)))
  }else{
    num <- sum(ysquig*x)
    denom <- sum(x^2) + 1/epsilon
    return(c(num/denom,1/(denom)))
  }
}

calc_y <- function(beta,j){
  Xtemp <- X[,-j]
  betaTemp <- beta[-j]
  XB <- colSums(t(Xtemp)*betaTemp)
  return(y - XB)
}

mcmcGibbs <- function(numIt, api, bpi, tau2, epsilon){
  niter <- numIt
  piSim <- numeric(length = niter)
  piSim[1] <- 0.05
  deltaSim <- matrix(nrow = p, ncol = niter)
  deltaSim[,1] <- 1
  betaSim <- matrix(nrow = p, ncol = niter)
  betaSim[,1] <- betaLSE
  
  for(i in 2:niter){
    betaVec <- betaSim[,i-1]
    for(j in 1:p){
      ysquiggle <- calc_y(beta = betaVec, j = j)
      deltaSim[j,i] <- rbernoulli(1,p = deltaParam(piSim[i-1],tau2,betaVec[j],epsilon))
      bParams <- betaParam(deltaSim[j,i],tau2,epsilon,ysquiggle,X[,j])
      betaVec[j] <- bParams[1]
      # meanval[j,i] <- bParams[1]
      # sigmaval[j,i] <- bParams[2]
      betaSim[j,i] <- rnorm(1,mean = bParams[1] ,sd = sqrt(bParams[2]))
    }
    piSim[i] <- rbeta(1,api/2+sum(deltaSim[,i]),bpi/2 + p - sum(deltaSim[,i]))
  }
  return(list(beta = betaSim, pi = piSim, delta = deltaSim))
}

res <- mcmcGibbs(numIt = 30000,api = 1, bpi = 1, tau2 = tau2, epsilon = epsilon)
betaThin <- res$beta[,seq(5001,30000,by = 15)]
betaThin <- as.data.table(t(betaThin))
setnames(betaThin, paste0("Beta_",1:10))
betaThin[,iter := seq_along(Beta_1)]
betaLong <- melt(betaThin, id.vars = "iter")

ggplot(betaLong, aes(x = value))+
  geom_histogram(binwidth = 0.05)+
  facet_wrap(.~variable,scales = "free_y")

plot(betaThin$Beta_1, type = "l")
#######################################################################################

```

```{r convergence, fig.width=8, fig.height=10}
###create 5 chains
chainResults <-  foreach(x = 1:5, .combine = rbind) %do% {
  cat(".")
  res <- mcmcGibbs(numIt = 20000,api = 1, bpi = 1, tau2 = tau2, epsilon = epsilon)
  betaThin <- res$beta[,seq(5001,20000,by = 8)]
  betaThin <- as.data.table(t(betaThin))
  betaThin[,Var := "Beta"]
  
  # piThin <- res$pi[seq(5001,20000,by = 8)]
  # piThin <- as.data.table(t(piThin))
  # piThin[,Var := "Pi"]
  
  out <- betaThin
  out[,Chain := x]
  out
}

chainsBeta <- chainResults[Var == "Beta",]
setnames(chainsBeta,c(paste0("Beta_",1:10),"Var","Chain"))
chainsBeta[,Iteration := rep(1:1875,5)]
chains2 <- melt(chainsBeta, id.vars = c("Var","Chain","Iteration"))
chains2[,Var := NULL]
setnames(chains2, c("Chain","Iteration","Parameter", "value"))
setcolorder(chains2, c("Chain","Iteration","Parameter","value"))

chains2 <- as_tibble(chains2)
attr(chains2, "nChains") <- 5
attr(chains2, "nParameters") <- 10
attr(chains2, "nIterations") <- 20000
attr(chains2, "nBurnin") <- 5000
attr(chains2, "nThin") <- 8

ggs_traceplot(chains2)

###now for pi
chainsBeta <- chainResults[Var == "Pi",]
setnames(chainsBeta,c(paste0("Pi_",1:10),"Var","Chain"))
chainsBeta[,Iteration := rep(1:1875,5)]
chains2 <- melt(chainsBeta, id.vars = c("Var","Chain","Iteration"))
chains2[,Var := NULL]
setnames(chains2, c("Chain","Iteration","Parameter", "value"))
setcolorder(chains2, c("Chain","Iteration","Parameter","value"))

chains2 <- as_tibble(chains2)
attr(chains2, "nChains") <- 5
attr(chains2, "nParameters") <- 10
attr(chains2, "nIterations") <- 20000
attr(chains2, "nBurnin") <- 5000
attr(chains2, "nThin") <- 8

ggobj <- ggs_traceplot(chains2)

ggobj+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

